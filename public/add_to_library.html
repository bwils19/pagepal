<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add a Book</title>
    <link rel="stylesheet" href="../static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

</head>
<body>

<div class="form-container">
    <div class="logo-container">
        <img src="images/books_icon.png" alt="Logo" class="logo">
        <span class="logo-text">PAGEPAL</span>
    </div>
    <h1>Add a Book</h1>
    <form id="bookForm" action="add_book.php" method="POST">
        <div>
            <label for="searchTitle">Book Title:</label>
            <input type="text" id="searchTitle" name="searchTitle" required>
            <button type="button" onclick="searchBook()">Search</button>
        </div>
        <div id="searchResults" style="display:none;">
            <label for="bookSelect">Select a Book:</label>
            <select id="bookSelect" onchange="populateBookDetails()">
                <option value="">Select a book</option>
            </select>
        </div>
        <div id="bookDetails" style="display:none;">
            <div>
                <label for="title">Title:</label>
                <input type="text" id="title" name="title" readonly>
            </div>
            <div>
                <label for="author">Author:</label>
                <input type="text" id="author" name="author" readonly>
            </div>
            <div>
                <label for="cover">Cover:</label>
                <input type="hidden" id="cover" name="cover">
                <img id="coverImage" alt="Book Cover" style="display: block; max-width: 100px;">
            </div>
            <div>
                <label for="pages">Pages:</label>
                <input type="text" id="pages" name="pages" readonly>
            </div>
            <div>
                <label for="summary">Summary:</label>
                <textarea id="summary" name="summary" rows="4" readonly></textarea>
            </div>
            <div>
                <label for="status">Status:</label>
                <select id="status" name="status" required onchange="toggleRating()">
                    <option value="want-to-read">Want to Read</option>
                    <option value="in-progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            <div id="ratingDiv" style="display:none;">
                <label for="rating">Rating:</label>
                <select id="rating" name="rating">
                    <option value="0">0</option>
                    <option value="0.5">0.5</option>
                    <option value="1">1</option>
                    <option value="1.5">1.5</option>
                    <option value="2">2</option>
                    <option value="2.5">2.5</option>
                    <option value="3">3</option>
                    <option value="3.5">3.5</option>
                    <option value="4">4</option>
                    <option value="4.5">4.5</option>
                    <option value="5">5</option>
                </select>
            </div>
            <div>
                <input type="submit" value="Add Book">
            </div>
        </div>
    </form>
</div>

<!-- This is the box that will pop up if the user is trying to add a book to the library when it already exists -->
<div id="duplicateModal" style="display:none;">
    <p>This book is already in your library, are you sure you want to continue adding?</p>
    <button onclick="continueAdding()">Continue Adding</button>
    <button onclick="closeModal()">Go Back</button>
</div>

<script>

    const supabaseUrl = 'https://ojygetcgjabzpxbmdaax.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qeWdldGNnamFienB4Ym1kYWF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjEzNDUyNzEsImV4cCI6MjAzNjkyMTI3MX0.K7M16UbjRvJ7YLf7YcTgEdmCbXz5rq1_jV8ERNUqxFA';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);
    let searchResults = [];
    let duplicateCheck = false;

    function searchBook() {
        const title = document.getElementById('searchTitle').value;
        if (!title) return;

        fetch(`https://openlibrary.org/search.json?title=${title}`)
            .then(response => response.json())
            .then(data => {
                if (data.docs.length > 0) {
                    searchResults = data.docs;
                    const bookSelect = document.getElementById('bookSelect');
                    bookSelect.innerHTML = '<option value="">Select a book</option>';
                    data.docs.forEach((book, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.text = `${book.title} by ${book.author_name ? book.author_name.join(', ') : 'Unknown'} (${book.first_publish_year || 'Unknown'})`;
                        bookSelect.appendChild(option);
                    });
                    document.getElementById('searchResults').style.display = 'block';
                    document.getElementById('bookDetails').style.display = 'none';
                } else {
                    alert('No books found.');
                    document.getElementById('searchResults').style.display = 'none';
                    document.getElementById('bookDetails').style.display = 'none';
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function populateBookDetails() {
        const selectedIndex = document.getElementById('bookSelect').value;
        if (selectedIndex === "") {
            clearBookDetails();
            document.getElementById('bookDetails').style.display = 'none';
            return;
        }

        const book = searchResults[selectedIndex];
        document.getElementById('title').value = book.title;
        document.getElementById('author').value = book.author_name ? book.author_name.join(', ') : 'Unknown';
        document.getElementById('pages').value = book.number_of_pages_median || 'Unknown';
        document.getElementById('summary').value = book.first_sentence ? book.first_sentence[0] : 'No summary available';
        document.getElementById('cover').value = book.cover_i ? `https://covers.openlibrary.org/b/id/${book.cover_i}-M.jpg` : '';
        if (book.cover_i) {
            document.getElementById('coverImage').src = `https://covers.openlibrary.org/b/id/${book.cover_i}-M.jpg`;
            document.getElementById('coverImage').style.display = 'block';
        } else {
            document.getElementById('coverImage').style.display = 'none';
        }

        document.getElementById('bookDetails').style.display = 'block';
    }

    function clearBookDetails() {
        document.getElementById('title').value = '';
        document.getElementById('author').value = '';
        document.getElementById('pages').value = '';
        document.getElementById('summary').value = '';
        document.getElementById('cover').value = '';
        document.getElementById('coverImage').style.display = 'none';
    }

    function toggleRating() {
        const status = document.getElementById('status').value;
        if (status === 'completed') {
            document.getElementById('ratingDiv').style.display = 'block';
        } else {
            document.getElementById('ratingDiv').style.display = 'none';
        }
    }

    document.getElementById('bookForm').addEventListener('submit', function(event) {
        event.preventDefault();
        if (!duplicateCheck) {
            checkDuplicate();
        } else {
            submitForm();
        }
    });

    function checkDuplicate() {
        const title = document.getElementById('title').value;
        const author = document.getElementById('author').value;

        fetch('dupe_check.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `title=${encodeURIComponent(title)}&author=${encodeURIComponent(author)}`,
        })
        .then(response => response.json())
        .then(data => {
            if (data.exists) {
                document.getElementById('duplicateModal').style.display = 'block';
            } else {
                submitForm();
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function continueAdding() {
        duplicateCheck = true;
        document.getElementById('duplicateModal').style.display = 'none';
        submitForm();
    }

    function closeModal() {
        document.getElementById('duplicateModal').style.display = 'none';
    }

    async function submitForm() {
        if (!supabase.auth.user()) {
            alert('You must be logged in to add books to your library.');
            return;
        }
        const formData = new FormData(document.getElementById('bookForm'));
        const title = formData.get('title');
        const author = formData.get('author');
        const cover = formData.get('cover');
        const pages = formData.get('pages');
        const summary = formData.get('summary');
        const status = formData.get('status');
        const rating = formData.get('rating') || null;

        try {
            const { data, error } = await supabase
                .from('user_books')
                .insert([
                    { title, author, cover, pages, summary, status, rating, user_id: supabase.auth.user().id }
                ]);

            if (error) {
                throw error;
            } else {
                console.log('Book added successfully!', data);
                alert('Book added successfully!');
                clearForm();
            }
        } catch (error) {
            console.error('Error adding book:', error.message);
            alert('Failed to add book. Please try again.');
        }
    }

    function clearForm() {
        document.getElementById('searchTitle').value = '';
        document.getElementById('searchResults').style.display = 'none';
        clearBookDetails();
        document.getElementById('bookDetails').style.display = 'none';
        document.getElementById('status').value = 'want-to-read';
        toggleRating();
        duplicateCheck = false; // reset dupe check
    }

    document.getElementById('searchTitle').addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            searchBook();
        }
    });
</script>

</body>
</html>
